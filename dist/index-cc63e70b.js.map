{"version":3,"file":"index-cc63e70b.js","sources":["../src/main/rendering/motion-animator/index.ts"],"sourcesContent":["/**\n * Copyright 2019 Google Inc. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *     http://www.apache.org/licenses/LICENSE-2.0\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport * as tslib_1 from \"tslib\";\nimport { bind } from \"src/utils/bind\";\nimport { removeAnimations } from \"../animation-helpers\";\nimport { rippleSpeed } from \"../constants\";\nimport { getTime, unfreeze } from \"../time-provider\";\nvar MotionAnimator = /** @class */ (function () {\n    function MotionAnimator(_numTilesX, _numTilesY, _renderer) {\n        this._numTilesX = _numTilesX;\n        this._numTilesY = _numTilesY;\n        this._renderer = _renderer;\n        this._renderLoopRunning = false;\n        this._changeBuffer = [];\n        this._lastTs = getTime();\n        unfreeze();\n        this._initCellDetails();\n        this._startRenderLoop();\n    }\n    Object.defineProperty(MotionAnimator.prototype, \"numTiles\", {\n        get: function () {\n            return this._numTilesX * this._numTilesY;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    MotionAnimator.prototype.updateCells = function (changes) {\n        var _a;\n        // Queue up changes to be consumed by animation rAF\n        (_a = this._changeBuffer).push.apply(_a, tslib_1.__spread(changes));\n    };\n    MotionAnimator.prototype.stop = function () {\n        this._renderLoopRunning = false;\n    };\n    MotionAnimator.prototype._initCellDetails = function () {\n        var startTime = getTime();\n        var rippleFactor = rippleSpeed * Math.max(this._numTilesX, this._numTilesY);\n        this._cellDetails = new Array(this.numTiles);\n        for (var y = 0; y < this._numTilesY; y++) {\n            for (var x = 0; x < this._numTilesX; x++) {\n                this._cellDetails[y * this._numTilesX + x] = {\n                    animationList: [\n                        {\n                            name: 0 /* IDLE */,\n                            start: startTime -\n                                rippleFactor +\n                                distanceFromCenter(x, y, this._numTilesX, this._numTilesY) *\n                                    rippleFactor\n                        }\n                    ],\n                    hasFlashed: false,\n                    x: x,\n                    y: y\n                };\n            }\n        }\n    };\n    MotionAnimator.prototype._updateAnimation = function (details) {\n        // tslint:disable-next-line:prefer-const\n        var cell = details.cell, animationList = details.animationList;\n        var ts = getTime();\n        if (!cell) {\n            console.warn(\"Unknown cell\");\n            return;\n        }\n        if (!cell.revealed && !cell.flagged) {\n            animationList[0].name = 0 /* IDLE */;\n            animationList[0].fadeStart = ts;\n            animationList = removeAnimations(animationList, [\n                3 /* HIGHLIGHT_IN */,\n                4 /* HIGHLIGHT_OUT */\n            ]);\n            animationList.push({\n                name: 4 /* HIGHLIGHT_OUT */,\n                start: ts,\n                done: function () {\n                    animationList = details.animationList;\n                    animationList = removeAnimations(animationList, [\n                        3 /* HIGHLIGHT_IN */,\n                        4 /* HIGHLIGHT_OUT */\n                    ]);\n                    details.animationList = animationList;\n                }\n            });\n        }\n        else if (!cell.revealed && cell.flagged) {\n            animationList[0].name = 6 /* FLAGGED */;\n            animationList[0].fadeStart = ts;\n            animationList.push({\n                name: 3 /* HIGHLIGHT_IN */,\n                start: ts\n            });\n        }\n        else if (cell.revealed) {\n            var isHighlighted = animationList.some(function (a) { return a.name === 3 /* HIGHLIGHT_IN */; });\n            if (cell.touchingFlags >= cell.touchingMines &&\n                cell.touchingMines > 0 &&\n                !isHighlighted) {\n                animationList.push({\n                    name: 3 /* HIGHLIGHT_IN */,\n                    start: ts\n                });\n            }\n            else if (cell.touchingFlags < cell.touchingMines && isHighlighted) {\n                animationList = removeAnimations(animationList, [\n                    3 /* HIGHLIGHT_IN */,\n                    4 /* HIGHLIGHT_OUT */\n                ]);\n                animationList.push({\n                    name: 4 /* HIGHLIGHT_OUT */,\n                    start: ts\n                });\n            }\n            details.animationList = animationList;\n            // This button already played the flash animation\n            if (details.hasFlashed) {\n                return;\n            }\n            animationList = removeAnimations(animationList, [0 /* IDLE */]);\n            details.hasFlashed = true;\n            animationList.push({\n                name: 1 /* FLASH_IN */,\n                start: ts,\n                done: function () {\n                    animationList = details.animationList;\n                    animationList = removeAnimations(animationList, [\n                        1 /* FLASH_IN */\n                    ]);\n                    details.animationList = animationList;\n                }\n            });\n            if (cell.hasMine) {\n                animationList.push({\n                    name: 7 /* MINED */,\n                    start: ts + 100\n                });\n            }\n            else {\n                animationList.unshift({\n                    name: 5 /* NUMBER */,\n                    start: ts + 100\n                });\n            }\n            animationList.push({\n                name: 2 /* FLASH_OUT */,\n                start: ts + 100\n            });\n        }\n        details.animationList = animationList;\n    };\n    MotionAnimator.prototype._animateTile = function (detail, ts) {\n        var e_1, _a;\n        try {\n            for (var _b = tslib_1.__values(detail.animationList), _c = _b.next(); !_c.done; _c = _b.next()) {\n                var animation = _c.value;\n                this._renderer.render(detail.x, detail.y, detail.cell, animation, ts);\n            }\n        }\n        catch (e_1_1) { e_1 = { error: e_1_1 }; }\n        finally {\n            try {\n                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\n            }\n            finally { if (e_1) throw e_1.error; }\n        }\n    };\n    MotionAnimator.prototype._startRenderLoop = function () {\n        if (this._renderLoopRunning) {\n            return;\n        }\n        this._renderLoopRunning = true;\n        requestAnimationFrame(this._renderLoop);\n    };\n    MotionAnimator.prototype._consumeChangeBuffer = function (delta) {\n        var e_2, _a;\n        // Reveal ~5 fields per frame\n        var numConsume = Math.floor((delta * 5) / 16);\n        var slice = this._changeBuffer.splice(0, numConsume);\n        try {\n            for (var slice_1 = tslib_1.__values(slice), slice_1_1 = slice_1.next(); !slice_1_1.done; slice_1_1 = slice_1.next()) {\n                var _b = tslib_1.__read(slice_1_1.value, 3), x = _b[0], y = _b[1], cellProps = _b[2];\n                var detail = this._cellDetails[y * this._numTilesX + x];\n                detail.cell = cellProps;\n                this._updateAnimation(detail);\n            }\n        }\n        catch (e_2_1) { e_2 = { error: e_2_1 }; }\n        finally {\n            try {\n                if (slice_1_1 && !slice_1_1.done && (_a = slice_1.return)) _a.call(slice_1);\n            }\n            finally { if (e_2) throw e_2.error; }\n        }\n    };\n    MotionAnimator.prototype._renderLoop = function () {\n        var e_3, _a;\n        var ts = getTime();\n        var delta = ts - this._lastTs;\n        this._lastTs = ts;\n        // Update animations according to incoming grid changes\n        this._consumeChangeBuffer(delta);\n        this._renderer.beforeUpdate();\n        try {\n            for (var _b = tslib_1.__values(this._cellDetails), _c = _b.next(); !_c.done; _c = _b.next()) {\n                var detail = _c.value;\n                this._renderer.beforeCell(detail.x, detail.y, detail.cell, detail.animationList, ts);\n                this._animateTile(detail, ts);\n                this._renderer.afterCell(detail.x, detail.y, detail.cell, detail.animationList, ts);\n            }\n        }\n        catch (e_3_1) { e_3 = { error: e_3_1 }; }\n        finally {\n            try {\n                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);\n            }\n            finally { if (e_3) throw e_3.error; }\n        }\n        this._renderer.afterUpdate();\n        if (this._renderLoopRunning) {\n            requestAnimationFrame(this._renderLoop);\n        }\n    };\n    tslib_1.__decorate([\n        bind\n    ], MotionAnimator.prototype, \"_renderLoop\", null);\n    return MotionAnimator;\n}());\nexport default MotionAnimator;\nfunction distanceFromCenter(x, y, width, height) {\n    var centerX = width / 2;\n    var centerY = height / 2;\n    // Measure the distance from the center point of the game board\n    // to the center of the field (hence the +0.5)\n    var dx = x + 0.5 - centerX;\n    var dy = y + 0.5 - centerY;\n    // Distance of our point to origin\n    return (Math.sqrt(dx * dx + dy * dy) /\n        Math.sqrt(centerX * centerX + centerY * centerY));\n}\n//# sourceMappingURL=index.js.map"],"names":["MotionAnimator","_numTilesX","_numTilesY","_renderer","this","_renderLoopRunning","_changeBuffer","_lastTs","getTime","unfreeze","_initCellDetails","_startRenderLoop","Object","defineProperty","prototype","get","enumerable","configurable","updateCells","changes","_a","push","apply","tslib_1.__spread","stop","startTime","rippleFactor","rippleSpeed","Math","max","_cellDetails","Array","numTiles","y","x","animationList","name","start","distanceFromCenter","hasFlashed","_updateAnimation","details","cell","ts","revealed","flagged","fadeStart","isHighlighted","some","a","touchingFlags","touchingMines","removeAnimations","done","hasMine","unshift","console","warn","_animateTile","detail","e_1","_b","tslib_1.__values","_c","next","animation","value","render","e_1_1","error","return","call","requestAnimationFrame","_renderLoop","_consumeChangeBuffer","delta","e_2","numConsume","floor","slice","splice","slice_1","slice_1_1","tslib_1.__read","cellProps","e_2_1","e_3","beforeUpdate","beforeCell","afterCell","e_3_1","afterUpdate","tslib_1.__decorate","bind","width","height","centerX","centerY","dx","dy","sqrt"],"mappings":"sJAiBA,IAAIA,EAAgC,WAChC,SAASA,EAAeC,EAAYC,EAAYC,GAC5CC,KAAKH,WAAaA,EAClBG,KAAKF,WAAaA,EAClBE,KAAKD,UAAYA,EACjBC,KAAKC,oBAAqB,EAC1BD,KAAKE,cAAgB,GACrBF,KAAKG,QAAUC,YACfC,aACAL,KAAKM,mBACLN,KAAKO,mBAgNT,OA9MAC,OAAOC,eAAeb,EAAec,UAAW,WAAY,CACxDC,IAAK,WACD,OAAOX,KAAKH,WAAaG,KAAKF,YAElCc,YAAY,EACZC,cAAc,IAElBjB,EAAec,UAAUI,YAAc,SAAUC,GAC7C,IAAIC,GAEHA,EAAKhB,KAAKE,eAAee,KAAKC,MAAMF,EAAIG,WAAiBJ,KAE9DnB,EAAec,UAAUU,KAAO,WAC5BpB,KAAKC,oBAAqB,GAE9BL,EAAec,UAAUJ,iBAAmB,WACxC,IAAIe,EAAYjB,YACZkB,EAAeC,cAAcC,KAAKC,IAAIzB,KAAKH,WAAYG,KAAKF,YAChEE,KAAK0B,aAAe,IAAIC,MAAM3B,KAAK4B,UACnC,IAAK,IAAIC,EAAI,EAAGA,EAAI7B,KAAKF,WAAY+B,IACjC,IAAK,IAAIC,EAAI,EAAGA,EAAI9B,KAAKH,WAAYiC,IACjC9B,KAAK0B,aAAaG,EAAI7B,KAAKH,WAAaiC,GAAK,CACzCC,cAAe,CACX,CACIC,KAAM,EACNC,MAAOZ,EACHC,EACAY,EAAmBJ,EAAGD,EAAG7B,KAAKH,WAAYG,KAAKF,YAC3CwB,IAGhBa,YAAY,EACZL,EAAGA,EACHD,EAAGA,IAKnBjC,EAAec,UAAU0B,iBAAmB,SAAUC,GAElD,IAAIC,EAAOD,EAAQC,KAAMP,EAAgBM,EAAQN,cAC7CQ,EAAKnC,YACT,GAAKkC,EAAL,CAIA,GAAKA,EAAKE,UAAaF,EAAKG,SAoBvB,IAAKH,EAAKE,UAAYF,EAAKG,QAC5BV,EAAc,GAAGC,KAAO,EACxBD,EAAc,GAAGW,UAAYH,EAC7BR,EAAcd,KAAK,CACfe,KAAM,EACNC,MAAOM,SAGV,GAAID,EAAKE,SAAU,CACpB,IAAIG,EAAgBZ,EAAca,KAAK,SAAUC,GAAK,OAAkB,IAAXA,EAAEb,OAqB/D,GApBIM,EAAKQ,eAAiBR,EAAKS,eAC3BT,EAAKS,cAAgB,IACpBJ,EACDZ,EAAcd,KAAK,CACfe,KAAM,EACNC,MAAOM,IAGND,EAAKQ,cAAgBR,EAAKS,eAAiBJ,IAChDZ,EAAgBiB,mBAAiBjB,EAAe,CAC5C,EACA,KAEUd,KAAK,CACfe,KAAM,EACNC,MAAOM,IAGfF,EAAQN,cAAgBA,EAEpBM,EAAQF,WACR,OAEJJ,EAAgBiB,mBAAiBjB,EAAe,CAAC,IACjDM,EAAQF,YAAa,EACrBJ,EAAcd,KAAK,CACfe,KAAM,EACNC,MAAOM,EACPU,KAAM,WACFlB,EAAgBM,EAAQN,cACxBA,EAAgBiB,mBAAiBjB,EAAe,CAC5C,IAEJM,EAAQN,cAAgBA,KAG5BO,EAAKY,QACLnB,EAAcd,KAAK,CACfe,KAAM,EACNC,MAAOM,EAAK,MAIhBR,EAAcoB,QAAQ,CAClBnB,KAAM,EACNC,MAAOM,EAAK,MAGpBR,EAAcd,KAAK,CACfe,KAAM,EACNC,MAAOM,EAAK,YA/EhBR,EAAc,GAAGC,KAAO,EACxBD,EAAc,GAAGW,UAAYH,GAC7BR,EAAgBiB,mBAAiBjB,EAAe,CAC5C,EACA,KAEUd,KAAK,CACfe,KAAM,EACNC,MAAOM,EACPU,KAAM,WACFlB,EAAgBM,EAAQN,cACxBA,EAAgBiB,mBAAiBjB,EAAe,CAC5C,EACA,IAEJM,EAAQN,cAAgBA,KAmEpCM,EAAQN,cAAgBA,OAtFpBqB,QAAQC,KAAK,iBAwFrBzD,EAAec,UAAU4C,aAAe,SAAUC,EAAQhB,GACtD,IAAIiB,EAAKxC,EACT,IACI,IAAK,IAAIyC,EAAKC,WAAiBH,EAAOxB,eAAgB4B,EAAKF,EAAGG,QAASD,EAAGV,KAAMU,EAAKF,EAAGG,OAAQ,CAC5F,IAAIC,EAAYF,EAAGG,MACnB9D,KAAKD,UAAUgE,OAAOR,EAAOzB,EAAGyB,EAAO1B,EAAG0B,EAAOjB,KAAMuB,EAAWtB,IAG1E,MAAOyB,GAASR,EAAM,CAAES,MAAOD,WAE3B,IACQL,IAAOA,EAAGV,OAASjC,EAAKyC,EAAGS,SAASlD,EAAGmD,KAAKV,WAE1C,GAAID,EAAK,MAAMA,EAAIS,SAGrCrE,EAAec,UAAUH,iBAAmB,WACpCP,KAAKC,qBAGTD,KAAKC,oBAAqB,EAC1BmE,sBAAsBpE,KAAKqE,eAE/BzE,EAAec,UAAU4D,qBAAuB,SAAUC,GACtD,IAAIC,EAAKxD,EAELyD,EAAajD,KAAKkD,MAAe,EAARH,EAAa,IACtCI,EAAQ3E,KAAKE,cAAc0E,OAAO,EAAGH,GACzC,IACI,IAAK,IAAII,EAAUnB,WAAiBiB,GAAQG,EAAYD,EAAQjB,QAASkB,EAAU7B,KAAM6B,EAAYD,EAAQjB,OAAQ,CACjH,IAAIH,EAAKsB,SAAeD,EAAUhB,MAAO,GAAIhC,EAAI2B,EAAG,GAAI5B,EAAI4B,EAAG,GAAIuB,EAAYvB,EAAG,GAC9EF,EAASvD,KAAK0B,aAAaG,EAAI7B,KAAKH,WAAaiC,GACrDyB,EAAOjB,KAAO0C,EACdhF,KAAKoC,iBAAiBmB,IAG9B,MAAO0B,GAAST,EAAM,CAAEP,MAAOgB,WAE3B,IACQH,IAAcA,EAAU7B,OAASjC,EAAK6D,EAAQX,SAASlD,EAAGmD,KAAKU,WAE7D,GAAIL,EAAK,MAAMA,EAAIP,SAGrCrE,EAAec,UAAU2D,YAAc,WACnC,IAAIa,EAAKlE,EACLuB,EAAKnC,YACLmE,EAAQhC,EAAKvC,KAAKG,QACtBH,KAAKG,QAAUoC,EAEfvC,KAAKsE,qBAAqBC,GAC1BvE,KAAKD,UAAUoF,eACf,IACI,IAAK,IAAI1B,EAAKC,WAAiB1D,KAAK0B,cAAeiC,EAAKF,EAAGG,QAASD,EAAGV,KAAMU,EAAKF,EAAGG,OAAQ,CACzF,IAAIL,EAASI,EAAGG,MAChB9D,KAAKD,UAAUqF,WAAW7B,EAAOzB,EAAGyB,EAAO1B,EAAG0B,EAAOjB,KAAMiB,EAAOxB,cAAeQ,GACjFvC,KAAKsD,aAAaC,EAAQhB,GAC1BvC,KAAKD,UAAUsF,UAAU9B,EAAOzB,EAAGyB,EAAO1B,EAAG0B,EAAOjB,KAAMiB,EAAOxB,cAAeQ,IAGxF,MAAO+C,GAASJ,EAAM,CAAEjB,MAAOqB,WAE3B,IACQ3B,IAAOA,EAAGV,OAASjC,EAAKyC,EAAGS,SAASlD,EAAGmD,KAAKV,WAE1C,GAAIyB,EAAK,MAAMA,EAAIjB,OAEjCjE,KAAKD,UAAUwF,cACXvF,KAAKC,oBACLmE,sBAAsBpE,KAAKqE,cAGnCmB,aAAmB,CACfC,QACD7F,EAAec,UAAW,cAAe,MACrCd,KAGX,SAASsC,EAAmBJ,EAAGD,EAAG6D,EAAOC,GACrC,IAAIC,EAAUF,EAAQ,EAClBG,EAAUF,EAAS,EAGnBG,EAAKhE,EAAI,GAAM8D,EACfG,EAAKlE,EAAI,GAAMgE,EAEnB,OAAQrE,KAAKwE,KAAKF,EAAKA,EAAKC,EAAKA,GAC7BvE,KAAKwE,KAAKJ,EAAUA,EAAUC,EAAUA"}